{"version":3,"file":"baseClient.cjs","sources":["../../../../src/clients/baseClient.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\nimport type { AxiosInstance, AxiosResponse } from 'axios';\nimport axios from 'axios';\nimport type { Callback } from '../callback';\nimport type { Client } from './client';\nimport type { Config, JiraError } from '../config';\nimport { ConfigSchema } from '../config';\nimport { getAuthenticationToken } from '../services/authenticationService';\nimport type { RequestConfig } from '../requestConfig';\nimport { HttpException, isObject } from './httpException';\nimport { ZodError } from 'zod';\n\nconst STRICT_GDPR_FLAG = 'x-atlassian-force-account-id';\nconst ATLASSIAN_TOKEN_CHECK_FLAG = 'X-Atlassian-Token';\nconst ATLASSIAN_TOKEN_CHECK_NOCHECK_VALUE = 'no-check';\n\nexport class BaseClient implements Client {\n  private instance: AxiosInstance;\n\n  constructor(protected readonly config: Config) {\n    try {\n      this.config = ConfigSchema.parse(config);\n    } catch (e) {\n      if (e instanceof ZodError && e.issues[0].message === 'Invalid URL') {\n        throw new Error(\n          'Couldn\\'t parse the host URL. Perhaps you forgot to add \\'http://\\' or \\'https://\\' at the beginning of the URL?',\n        );\n      }\n\n      throw e;\n    }\n\n    this.instance = axios.create({\n      paramsSerializer: this.paramSerializer.bind(this),\n      ...config.baseRequestConfig,\n      baseURL: config.host,\n      headers: this.removeUndefinedProperties({\n        [STRICT_GDPR_FLAG]: config.strictGDPR,\n        [ATLASSIAN_TOKEN_CHECK_FLAG]: config.noCheckAtlassianToken ? ATLASSIAN_TOKEN_CHECK_NOCHECK_VALUE : undefined,\n        ...config.baseRequestConfig?.headers,\n      }),\n    });\n  }\n\n  protected paramSerializer(parameters: Record<string, any>): string {\n    const parts: string[] = [];\n\n    Object.entries(parameters).forEach(([key, value]) => {\n      if (value === null || typeof value === 'undefined') {\n        return;\n      }\n\n      if (Array.isArray(value)) {\n        value = value.join(',');\n      }\n\n      if (value instanceof Date) {\n        value = value.toISOString();\n      } else if (value !== null && typeof value === 'object') {\n        value = JSON.stringify(value);\n      } else if (value instanceof Function) {\n        const part = value();\n\n        return part && parts.push(part);\n      }\n\n      parts.push(`${this.encode(key)}=${this.encode(value)}`);\n    });\n\n    return parts.join('&');\n  }\n\n  protected encode(value: string) {\n    return encodeURIComponent(value)\n      .replace(/%3A/gi, ':')\n      .replace(/%24/g, '$')\n      .replace(/%2C/gi, ',')\n      .replace(/%20/g, '+')\n      .replace(/%5B/gi, '[')\n      .replace(/%5D/gi, ']');\n  }\n\n  protected removeUndefinedProperties(obj: Record<string, any>): Record<string, any> {\n    return Object.entries(obj)\n      .filter(([, value]) => typeof value !== 'undefined')\n      .reduce((accumulator, [key, value]) => ({ ...accumulator, [key]: value }), {});\n  }\n\n  async sendRequest<T>(requestConfig: RequestConfig, callback: never): Promise<T>;\n  async sendRequest<T>(requestConfig: RequestConfig, callback: Callback<T>): Promise<void>;\n  async sendRequest<T>(requestConfig: RequestConfig, callback: Callback<T> | never): Promise<void | T> {\n    try {\n      const response = await this.sendRequestFullResponse<T>(requestConfig);\n\n      return this.handleSuccessResponse(response.data, callback);\n    } catch (e: unknown) {\n      return this.handleFailedResponse(e, callback);\n    }\n  }\n\n  async sendRequestFullResponse<T>(requestConfig: RequestConfig): Promise<AxiosResponse<T>> {\n    const modifiedRequestConfig = {\n      ...requestConfig,\n      headers: this.removeUndefinedProperties({\n        Authorization: await getAuthenticationToken(this.config.authentication),\n        ...requestConfig.headers,\n      }),\n    };\n\n    return this.instance.request<T>(modifiedRequestConfig);\n  }\n\n  handleSuccessResponse<T>(response: any, callback?: Callback<T> | never): T | void {\n    const callbackResponseHandler = callback && ((data: T): void => callback(null, data));\n    const defaultResponseHandler = (data: T): T => data;\n\n    const responseHandler = callbackResponseHandler ?? defaultResponseHandler;\n\n    this.config.middlewares?.onResponse?.(response.data);\n\n    return responseHandler(response);\n  }\n\n  handleFailedResponse<T>(e: unknown, callback?: Callback<T> | never): void {\n    const err = this.buildErrorHandlingResponse(e);\n\n    const callbackErrorHandler = callback && ((error: JiraError) => callback(error));\n    const defaultErrorHandler = (error: JiraError) => {\n      throw error;\n    };\n\n    const errorHandler = callbackErrorHandler ?? defaultErrorHandler;\n\n    this.config.middlewares?.onError?.(err);\n\n    return errorHandler(err);\n  }\n\n  private buildErrorHandlingResponse(e: unknown): JiraError {\n    if (axios.isAxiosError(e) && e.response) {\n      return new HttpException(\n        {\n          code: e.code,\n          message: e.message,\n          data: e.response.data,\n          status: e.response.status,\n          statusText: e.response.statusText,\n        },\n        e.response.status,\n        { cause: e },\n      );\n    }\n\n    if (axios.isAxiosError(e)) {\n      return e;\n    }\n\n    if (isObject(e) && isObject((e as Record<string, any>).response)) {\n      return new HttpException((e as Record<string, any>).response);\n    }\n\n    if (e instanceof Error) {\n      return new HttpException(e);\n    }\n\n    return new HttpException('Unknown error occurred.', 500, { cause: e });\n  }\n}\n"],"names":["config","ConfigSchema","ZodError","getAuthenticationToken","HttpException","isObject"],"mappings":"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"}