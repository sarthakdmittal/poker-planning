import axios from 'axios';
import { ConfigSchema } from '../config.mjs';
import { getAuthenticationToken } from '../services/authenticationService/getAuthenticationToken.mjs';
import { HttpException, isObject } from './httpException.mjs';
import { ZodError } from 'zod';

const STRICT_GDPR_FLAG = 'x-atlassian-force-account-id';
const ATLASSIAN_TOKEN_CHECK_FLAG = 'X-Atlassian-Token';
const ATLASSIAN_TOKEN_CHECK_NOCHECK_VALUE = 'no-check';
class BaseClient {
    config;
    instance;
    constructor(config) {
        this.config = config;
        try {
            this.config = ConfigSchema.parse(config);
        }
        catch (e) {
            if (e instanceof ZodError && e.issues[0].message === 'Invalid URL') {
                throw new Error('Couldn\'t parse the host URL. Perhaps you forgot to add \'http://\' or \'https://\' at the beginning of the URL?');
            }
            throw e;
        }
        this.instance = axios.create({
            paramsSerializer: this.paramSerializer.bind(this),
            ...config.baseRequestConfig,
            baseURL: config.host,
            headers: this.removeUndefinedProperties({
                [STRICT_GDPR_FLAG]: config.strictGDPR,
                [ATLASSIAN_TOKEN_CHECK_FLAG]: config.noCheckAtlassianToken ? ATLASSIAN_TOKEN_CHECK_NOCHECK_VALUE : undefined,
                ...config.baseRequestConfig?.headers,
            }),
        });
    }
    paramSerializer(parameters) {
        const parts = [];
        Object.entries(parameters).forEach(([key, value]) => {
            if (value === null || typeof value === 'undefined') {
                return;
            }
            if (Array.isArray(value)) {
                value = value.join(',');
            }
            if (value instanceof Date) {
                value = value.toISOString();
            }
            else if (value !== null && typeof value === 'object') {
                value = JSON.stringify(value);
            }
            else if (value instanceof Function) {
                const part = value();
                return part && parts.push(part);
            }
            parts.push(`${this.encode(key)}=${this.encode(value)}`);
        });
        return parts.join('&');
    }
    encode(value) {
        return encodeURIComponent(value)
            .replace(/%3A/gi, ':')
            .replace(/%24/g, '$')
            .replace(/%2C/gi, ',')
            .replace(/%20/g, '+')
            .replace(/%5B/gi, '[')
            .replace(/%5D/gi, ']');
    }
    removeUndefinedProperties(obj) {
        return Object.entries(obj)
            .filter(([, value]) => typeof value !== 'undefined')
            .reduce((accumulator, [key, value]) => ({ ...accumulator, [key]: value }), {});
    }
    async sendRequest(requestConfig, callback) {
        try {
            const response = await this.sendRequestFullResponse(requestConfig);
            return this.handleSuccessResponse(response.data, callback);
        }
        catch (e) {
            return this.handleFailedResponse(e, callback);
        }
    }
    async sendRequestFullResponse(requestConfig) {
        const modifiedRequestConfig = {
            ...requestConfig,
            headers: this.removeUndefinedProperties({
                Authorization: await getAuthenticationToken(this.config.authentication),
                ...requestConfig.headers,
            }),
        };
        return this.instance.request(modifiedRequestConfig);
    }
    handleSuccessResponse(response, callback) {
        const callbackResponseHandler = callback && ((data) => callback(null, data));
        const defaultResponseHandler = (data) => data;
        const responseHandler = callbackResponseHandler ?? defaultResponseHandler;
        this.config.middlewares?.onResponse?.(response.data);
        return responseHandler(response);
    }
    handleFailedResponse(e, callback) {
        const err = this.buildErrorHandlingResponse(e);
        const callbackErrorHandler = callback && ((error) => callback(error));
        const defaultErrorHandler = (error) => {
            throw error;
        };
        const errorHandler = callbackErrorHandler ?? defaultErrorHandler;
        this.config.middlewares?.onError?.(err);
        return errorHandler(err);
    }
    buildErrorHandlingResponse(e) {
        if (axios.isAxiosError(e) && e.response) {
            return new HttpException({
                code: e.code,
                message: e.message,
                data: e.response.data,
                status: e.response.status,
                statusText: e.response.statusText,
            }, e.response.status, { cause: e });
        }
        if (axios.isAxiosError(e)) {
            return e;
        }
        if (isObject(e) && isObject(e.response)) {
            return new HttpException(e.response);
        }
        if (e instanceof Error) {
            return new HttpException(e);
        }
        return new HttpException('Unknown error occurred.', 500, { cause: e });
    }
}

export { BaseClient };
//# sourceMappingURL=baseClient.mjs.map
